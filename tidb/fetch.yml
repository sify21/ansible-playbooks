---

- hosts: localhost
  connection: local
  name: download tidb binaries
  tags:
      - local
  vars:
      root_pwd: "{{ lookup('env','ROOT_PWD') }}"
      tidb_pwd: "{{ lookup('env','TIDB_PWD') }}"
  tasks:
      - debug:
          msg: "verifying ROOT_PWD environment variable is set"
        failed_when: root_pwd == ''
      - debug:
          msg: "verifying TIDB_PWD environment variable is set"
        failed_when: tidb_pwd == ''
      - file:
          path: "{{ playbook_dir }}/downloads"
          state: directory
          mode: 0755
      - get_url:
          dest: "{{ playbook_dir }}/downloads/tidb-latest-linux-amd64.tar.gz"
          url: https://download.pingcap.org/tidb-latest-linux-amd64.tar.gz
          checksum: sha256:https://download.pingcap.org/tidb-latest-linux-amd64.sha256
- hosts: all
  name: prepare remote system
  vars:
      ansible_user: root
      ansible_password: "{{ lookup('env','ROOT_PWD') }}"
      tidb_password: "{{ lookup('env','TIDB_PWD') }}"
  tasks:
      - user:
          name: tidb
          state: present
          system: yes
          password: "{{ tidb_password | password_hash('sha512', 'mysecretsalt') }}"
          expires: -1
        name: create tidb user
- hosts: all
  name: deploy
  vars:
      ansible_password: "{{ lookup('env','TIDB_PWD') }}"
  tasks:
      - copy:
          dest: /home/tidb/tidb.tar.gz
          src: downloads/tidb-latest-linux-amd64.tar.gz
        name: copy binary file
      - shell:
          chdir: /home/tidb
          cmd: tar -xzf tidb.tar.gz
        name: extract binary file
- hosts: pd_servers
  name: start pd servers
  vars:
      ansible_password: "{{ lookup('env','TIDB_PWD') }}"
- hosts: tikv_servers
  name: start tikv servers
  vars:
      ansible_password: "{{ lookup('env','TIDB_PWD') }}"
- hosts: tidb_servers
  name: start tidb servers
  vars:
      ansible_password: "{{ lookup('env','TIDB_PWD') }}"
  tasks:
      - shell:
          chdir: /home/tidb/tidb-latest-linux-amd64
          cmd: ./bin/tidb-server --store=tikv --log-file=tidb.log --path="" &

